<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>서울 따릉이 대여소 지도</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster (optional) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .map-title {
      position: absolute; z-index: 1000; left: 12px; top: 12px;
      background: rgba(255,255,255,0.9); backdrop-filter: saturate(1.2) blur(2px);
      border-radius: 12px; padding: 10px 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08);
      font-size: 14px; line-height: 1.2; color: #111; font-weight: 600;
    }
    .loader {
      position: absolute; z-index: 1000; right: 12px; top: 12px;
      background: rgba(255,255,255,.9); border-radius: 10px; padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.08); font-size: 12px; color:#333;
    }
    .leaflet-popup-content b { font-size: 14px; }
    .leaflet-popup-content small { color:#555; }
    @media (prefers-color-scheme: dark) {
      .map-title, .loader { background: rgba(32,32,32,0.85); color: #e8e8e8; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-title">서울 따릉이 대여소 지도</div>
  <div class="loader" id="loader">로딩 중…</div>

  <script>
    // ① 지도 준비
    const map = L.map('map', { center: [37.5665, 126.9780], zoom: 12, scrollWheelZoom: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ② 클러스터 레이어
    const cluster = L.markerClusterGroup({ showCoverageOnHover: false, spiderfyOnMaxZoom: true });
    map.addLayer(cluster);

    // ③ 데이터 로드 (같은 폴더의 stations.json, 배열형)
    fetch('stations.json', { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('stations.json을 불러오지 못했습니다.');
        return r.json();
      })
      .then(stores => {
        const bounds = [];
        stores.forEach(s => {
          if (!Number.isFinite(s.lat) || !Number.isFinite(s.lng)) return;
          const html = `
            <div>
              <b>${esc(s.name ?? '')}</b><br/>
              <small>${esc(s.district ?? '')}</small><br/>
              <small>${esc(s.address ?? '')}</small><br/>
              <small>거치대수: ${s.capacity ?? '-'}</small><br/>
              ${s.installed_at ? `<small>설치: ${esc(s.installed_at)}</small><br/>` : ''}
              <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">구글지도 열기</a>
            </div>`;
          const m = L.marker([s.lat, s.lng]).bindPopup(html);
          cluster.addLayer(m);
          bounds.push([s.lat, s.lng]);
        });
        if (bounds.length) map.fitBounds(bounds, { padding: [24,24] });
      })
      .catch(err => {
        console.error(err);
        alert('데이터 로딩 오류: ' + err.message);
      })
      .finally(() => {
        const el = document.getElementById('loader');
        if (el) el.remove();
      });

    // ④ 안전한 텍스트 출력
    function esc(str) {
      return String(str).replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
  </script>
</body>
</html>
