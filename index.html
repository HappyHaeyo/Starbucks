<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>서울 따릉이 대여소 지도</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --green-50:#f0fdf4;   /* 아주 연한 연두 배경 */
      --green-100:#dcfce7;
      --green-200:#bbf7d0;
      --green-300:#86efac;
      --green-400:#4ade80;
      --green-500:#22c55e;  /* 메인 연두 */
      --green-700:#15803d;  /* 진한 연두(포커스) */
      --ink:#0b1b13;        /* 잉크색 텍스트 */
    }
    html, body { height: 100%; margin: 0; background: var(--green-50); }
    #map { height: 100%; width: 100%; }

    /* 상단 좌측 타이틀 */
    .map-title {
      position: absolute; z-index: 1000; left: 12px; top: 12px;
      background: rgba(240,253,244,.95);
      border: 1px solid var(--green-200);
      border-radius: 12px; padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(21,128,61,.08);
      font: 700 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--ink);
    }

    /* 상단 우측 토글 컨트롤 */
    .map-controls {
      position: absolute; z-index: 1000; right: 12px; top: 12px;
      display: flex; gap: 8px; align-items: center;
      background: rgba(240,253,244,.95);
      border: 1px solid var(--green-200);
      border-radius: 12px; padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(21,128,61,.08);
      font: 500 13px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--ink);
    }
    .btn {
      border: 1px solid var(--green-200);
      border-radius: 10px; padding: 8px 10px; cursor: pointer; user-select: none;
      background: white; color: var(--ink);
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover { transform: translateY(-1px); background: var(--green-100); }
    .btn.active { border-color: var(--green-500); box-shadow: 0 0 0 2px var(--green-100) inset; font-weight: 700; }

    /* 팝업 */
    .leaflet-popup-content { margin: 8px 10px; }
    .leaflet-popup-content b { font-size: 14px; color: var(--ink); }
    .leaflet-popup-content small { color:#2b4739; }

    /* 🚲 자전거 아이콘 (divIcon) */
    .bike-pin {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--green-500); color: #fff;
      display:flex; align-items:center; justify-content:center;
      font-size: 16px; line-height: 1; box-shadow: 0 2px 8px rgba(21,128,61,.30);
      transform: translate(-14px, -14px); /* 중앙 정렬 */
      border: 2px solid #fff;
    }

    /* 클러스터도 연두색 계열로 */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background: var(--green-400); color: #0b1b13; border: 2px solid #fff;
    }
    .marker-cluster div {
      background: var(--green-500); color: #fff; border-radius: 50%; border: 2px solid #fff;
      font: 800 12px/26px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      width: 28px; height: 28px;
      box-shadow: 0 2px 8px rgba(21,128,61,.25);
    }

    @media (prefers-color-scheme: dark) {
      html, body { background: #0a1510; }
      .map-title, .map-controls { background: rgba(12,28,20,.9); border-color:#163d2a; color:#e8f6ed; }
      .btn { background:#0f2419; border-color:#163d2a; color:#e8f6ed; }
      .btn.active { border-color:#34d399; box-shadow: 0 0 0 2px rgba(52,211,153,.12) inset; }
      .bike-pin { background:#34d399; color:#0a1510; border-color:#0f2419; }
      .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background:#22c55e; border-color:#0f2419; }
      .marker-cluster div { background:#34d399; color:#0a1510; border-color:#0f2419; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-title">서울 따릉이 대여소 지도</div>
  <div class="map-controls">
    보기:
    <button id="btn-cluster" class="btn active">마커 합치기</button>
    <button id="btn-plain" class="btn">그대로 보기</button>
  </div>

  <script>
    // 1) 지도: 밝은 미니멀 타일(라이트 그린 톤에 잘 어울림)
    const map = L.map('map', { center: [37.5665, 126.9780], zoom: 12, scrollWheelZoom: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    // 2) 레이어: 클러스터 / 개별
    const clusterLayer = L.markerClusterGroup({ showCoverageOnHover: false, spiderfyOnMaxZoom: true });
    const plainLayer   = L.layerGroup();

    // 3) 🚲 아이콘
    const bikeIcon = L.divIcon({
      className: 'bike-pin',
      html: '🚲',
      iconSize: [28,28],
      iconAnchor: [14,14],
      popupAnchor: [0,-12]
    });

    // 4) 데이터 로드 (같은 폴더의 stations.json; 최상위 배열)
    fetch('stations.json', { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('stations.json을 불러오지 못했습니다.');
        return r.json();
      })
      .then(stores => {
        const bounds = [];
        stores.forEach(s => {
          if (!Number.isFinite(s.lat) || !Number.isFinite(s.lng)) return;
          const popup = `
            <div>
              <b>${esc(s.name ?? '')}</b><br/>
              <small>${esc(s.district ?? '')}</small><br/>
              <small>${esc(s.address ?? '')}</small><br/>
              <small>거치대수: ${s.capacity ?? '-'}</small><br/>
              ${s.installed_at ? `<small>설치: ${esc(s.installed_at)}</small><br/>` : ''}
              <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">구글지도 열기</a>
            </div>`;

          const m1 = L.marker([s.lat, s.lng], { icon: bikeIcon }).bindPopup(popup);
          const m2 = L.marker([s.lat, s.lng], { icon: bikeIcon }).bindPopup(popup);
          clusterLayer.addLayer(m1);
          plainLayer.addLayer(m2);
          bounds.push([s.lat, s.lng]);
        });

        // 초기: 클러스터
        map.addLayer(clusterLayer);
        if (bounds.length) map.fitBounds(bounds, { padding: [24,24] });

        // 토글
        const btnCluster = document.getElementById('btn-cluster');
        const btnPlain   = document.getElementById('btn-plain');

        btnCluster.addEventListener('click', () => {
          if (map.hasLayer(clusterLayer)) return;
          map.removeLayer(plainLayer);
          map.addLayer(clusterLayer);
          btnCluster.classList.add('active');
          btnPlain.classList.remove('active');
        });

        btnPlain.addEventListener('click', () => {
          if (map.hasLayer(plainLayer)) return;
          map.removeLayer(clusterLayer);
          map.addLayer(plainLayer);
          btnPlain.classList.add('active');
          btnCluster.classList.remove('active');
        });
      })
      .catch(err => {
        console.error(err);
        alert('데이터 로딩 오류: ' + err.message);
      });

    // 유틸: XSS 방지
    function esc(str) {
      return String(str).replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
  </script>
</body>
</html>
