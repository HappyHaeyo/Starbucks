<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì„œìš¸ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì§€ë„</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    /* ìƒë‹¨ ì¢Œì¸¡ íƒ€ì´í‹€ */
    .map-title {
      position: absolute; z-index: 1000; left: 12px; top: 12px;
      background: rgba(255,255,255,.9); backdrop-filter: saturate(1.1) blur(2px);
      border-radius: 12px; padding: 10px 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06);
      font: 600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #111;
    }

    /* ìƒë‹¨ ìš°ì¸¡ í† ê¸€ ì»¨íŠ¸ë¡¤ */
    .map-controls {
      position: absolute; z-index: 1000; right: 12px; top: 12px;
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,.9); border-radius: 12px; padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06); font: 500 13px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .btn {
      border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; cursor: pointer; user-select: none;
      background: #fff; color: #111;
    }
    .btn.active { border-color: #111; font-weight: 700; }

    /* íŒì—… íƒ€ì´í¬ ìµœì†Œí™” */
    .leaflet-popup-content { margin: 8px 10px; }
    .leaflet-popup-content b { font-size: 14px; }
    .leaflet-popup-content small { color:#555; }

    /* ëª¨ë…¸í†¤(ë‹¨ìƒ‰) ëŠë‚Œìœ¼ë¡œ íƒ€ì¼ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ */
    .leaflet-tile { filter: grayscale(100%) contrast(1.05) brightness(0.97); }

    /* ìì „ê±° ì•„ì´ì½˜(divIcon, ê³ í•´ìƒë„ ê¸€ë¦¬í”„) */
    .bike-pin {
      width: 28px; height: 28px; border-radius: 50%;
      background: #111; color: #fff; display:flex; align-items:center; justify-content:center;
      font-size: 16px; line-height: 1; box-shadow: 0 1px 6px rgba(0,0,0,.2);
      transform: translate(-14px, -14px); /* ì¤‘ì•™ ì •ë ¬ */
      border: 2px solid #fff;
    }

    /* í´ëŸ¬ìŠ¤í„° ìƒ‰ë„ ëª¨ë…¸í†¤ */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background: #111; color: #fff; border: 2px solid #fff;
    }
    .marker-cluster div {
      background: #111; color: #fff; border-radius: 50%; border: none;
      font: 700 12px/28px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      width: 28px; height: 28px;
    }

    @media (prefers-color-scheme: dark) {
      .map-title, .map-controls { background: rgba(28,28,28,.9); color: #e8e8e8; }
      .btn { background:#1e1e1e; border-color:#333; color:#e8e8e8; }
      .btn.active { border-color:#e8e8e8; }
      .leaflet-tile { filter: grayscale(100%) contrast(1.05) brightness(0.8); }
      .bike-pin { background:#e8e8e8; color:#111; border-color:#1e1e1e; }
      .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background:#e8e8e8; color:#111; border-color:#1e1e1e; }
      .marker-cluster div { background:#e8e8e8; color:#111; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-title">ì„œìš¸ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì§€ë„</div>
  <div class="map-controls">
    ë³´ê¸°:
    <button id="btn-cluster" class="btn active">ë§ˆì»¤ í•©ì¹˜ê¸°</button>
    <button id="btn-plain" class="btn">ê·¸ëŒ€ë¡œ ë³´ê¸°</button>
  </div>

  <script>
    // 1) ì§€ë„ ìƒì„± (Carto Positron íƒ€ì¼: ë¯¸ë‹ˆë©€ ë¼ì´íŠ¸í†¤)
    const map = L.map('map', { center: [37.5665, 126.9780], zoom: 12, scrollWheelZoom: true });

    L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap &copy; CARTO'
      }
    ).addTo(map);

    // 2) ë ˆì´ì–´ ì¤€ë¹„: í´ëŸ¬ìŠ¤í„° / í‰ë©´(ê°œë³„)
    const clusterLayer = L.markerClusterGroup({ showCoverageOnHover: false, spiderfyOnMaxZoom: true });
    const plainLayer   = L.layerGroup();

    // 3) ê³µìš© ì•„ì´ì½˜(ğŸš²) - divIconìœ¼ë¡œ ì‹¬í”Œ, ê³ ëŒ€ë¹„
    const bikeIcon = (function(){
      const html = 'ğŸš²';
      return L.divIcon({ className: 'bike-pin', html, iconSize: [28,28], iconAnchor: [14,14], popupAnchor: [0,-12] });
    })();

    // 4) ë°ì´í„° ë¡œë“œ (ê°™ì€ í´ë”ì˜ stations.json; ìµœìƒìœ„ "ë°°ì—´í˜•")
    fetch('stations.json', { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('stations.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return r.json();
      })
      .then(stores => {
        const bounds = [];
        // ë§ˆì»¤ë¥¼ ë‘ ë ˆì´ì–´ ëª¨ë‘ì— ìƒì„±(ì¤‘ë³µ ë Œë” ë°©ì§€ ìœ„í•´ í•œ ë²ˆì— ë§Œë“¤ê³  ê°ê° add)
        stores.forEach(s => {
          if (!Number.isFinite(s.lat) || !Number.isFinite(s.lng)) return;

          const popup = `
            <div>
              <b>${esc(s.name ?? '')}</b><br/>
              <small>${esc(s.district ?? '')}</small><br/>
              <small>${esc(s.address ?? '')}</small><br/>
              <small>ê±°ì¹˜ëŒ€ìˆ˜: ${s.capacity ?? '-'}</small><br/>
              ${s.installed_at ? `<small>ì„¤ì¹˜: ${esc(s.installed_at)}</small><br/>` : ''}
              <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">êµ¬ê¸€ì§€ë„ ì—´ê¸°</a>
            </div>`;

          const marker = L.marker([s.lat, s.lng], { icon: bikeIcon }).bindPopup(popup);
          // ë‘ ë ˆì´ì–´ì— ë™ì¼ ë§ˆì»¤ë¥¼ ê°ê° ë§Œë“¤ì–´ ë„£ëŠ” ëŒ€ì‹ , ì„±ëŠ¥/ë©”ëª¨ë¦¬ ì ˆì•½ì„ ìœ„í•´ clone ëŒ€ì‹  ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
          const marker2 = L.marker([s.lat, s.lng], { icon: bikeIcon }).bindPopup(popup);

          clusterLayer.addLayer(marker);
          plainLayer.addLayer(marker2);
          bounds.push([s.lat, s.lng]);
        });

        // ì´ˆê¸° ìƒíƒœ: í´ëŸ¬ìŠ¤í„° í‘œì‹œ
        map.addLayer(clusterLayer);
        if (bounds.length) map.fitBounds(bounds, { padding: [24,24] });

        // í† ê¸€ ë²„íŠ¼ ì—°ê²°
        const btnCluster = document.getElementById('btn-cluster');
        const btnPlain   = document.getElementById('btn-plain');

        btnCluster.addEventListener('click', () => {
          if (map.hasLayer(clusterLayer)) return;
          map.removeLayer(plainLayer);
          map.addLayer(clusterLayer);
          btnCluster.classList.add('active');
          btnPlain.classList.remove('active');
        });

        btnPlain.addEventListener('click', () => {
          if (map.hasLayer(plainLayer)) return;
          map.removeLayer(clusterLayer);
          map.addLayer(plainLayer);
          btnPlain.classList.add('active');
          btnCluster.classList.remove('active');
        });
      })
      .catch(err => {
        console.error(err);
        alert('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: ' + err.message);
      });

    // ìœ í‹¸: XSS ë°©ì§€ ì´ìŠ¤ì¼€ì´í”„
    function esc(str) {
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>
